name: Ksunati Multi-Universal (Samsung & Xiaomi)

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Linki (Ã–rn: kullanici/repo veya https://...)'
        required: true
        default: 'oliplusmzr/android_kernel_samsung_a24'
      KERNEL_BRANCH:
        description: 'Branch (Ã–rn: OSRC veya main)'
        required: true
        default: 'OSRC'
      DEFCONFIG_NAME:
        description: 'Defconfig DosyasÄ± (Ã–rn: a24_defconfig veya vendor/surya_defconfig)'
        required: true
        default: 'a24_defconfig'
      ROOT_METHOD:
        description: 'Root YÃ¶ntemi'
        required: true
        default: 'KernelSU-Next'
        type: choice
        options:
        - None
        - KernelSU
        - KernelSU-Next
        - SukiSU-Ultra
        - Wild-KSU
        - APatch
      USE_SUSFS:
        description: 'ğŸ‘» SuSFS (Otomatik SÃ¼rÃ¼m Tespiti)'
        required: true
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Kaynak KodlarÄ± Ã‡ek
      run: |
        rm -rf android_kernel
        echo "â¬‡ï¸ Hedef Repo: ${{ inputs.KERNEL_REPO }} -> ${{ inputs.KERNEL_BRANCH }}"
        
        # Link kontrolÃ¼ (Tam link mi yoksa kullanÄ±cÄ±/repo mu?)
        if [[ "${{ inputs.KERNEL_REPO }}" == http* ]]; then
            git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} ${{ inputs.KERNEL_REPO }} android_kernel
        else
            git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} https://github.com/${{ inputs.KERNEL_REPO }} android_kernel
        fi

    - name: ğŸ³ Docker ile AkÄ±llÄ± Derleme
      run: |
        chmod -R 777 android_kernel
        
        docker run --rm -v $PWD/android_kernel:/kernel ubuntu:20.04 bash -c "
            # --- 1. Ortam HazÄ±rlÄ±ÄŸÄ± ---
            echo 'ğŸ“¦ Paketler YÃ¼kleniyor...'
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
            git bc bison flex libssl-dev build-essential libncurses5-dev libncurses5 \
            libelf-dev gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi dwarves cpio \
            wget curl kmod ca-certificates python2 python3 zip unzip
            
            ln -sf /usr/bin/python2 /usr/bin/python
            git config --global --add safe.directory '*'
            git config --global --add safe.directory /kernel
            
            cd /kernel
            
            # --- 2. AkÄ±llÄ± SuSFS (4.14 ve GKI AyrÄ±mÄ±) ---
            if [ '${{ inputs.USE_SUSFS }}' = 'true' ]; then
                echo 'ğŸ‘» SuSFS Kontrol Ediliyor...'
                
                # Makefile'dan sÃ¼rÃ¼m okuma
                K_VER=\$(grep \"^VERSION =\" Makefile | awk '{print \$3}')
                K_LVL=\$(grep \"^PATCHLEVEL =\" Makefile | awk '{print \$3}')
                KERNEL_MAJOR=\"\$K_VER.\$K_LVL\"
                echo \"ğŸ–¥ï¸ Tespit Edilen Kernel: \$KERNEL_MAJOR\"

                if [ \"\$KERNEL_MAJOR\" == \"4.14\" ]; then
                    echo \"ğŸ”§ Eski Toprak (4.14) algÄ±landÄ± -> Legacy Yama\"
                    git clone -b kernel-4.14 https://gitlab.com/simonpunk/susfs4ksu.git
                    cp -r susfs4ksu/kernel_patches/fs/* fs/
                    cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/
                    patch -p1 < susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.14.patch || echo 'âŒ Yama HatasÄ± (4.14)'

                elif [ \"\$KERNEL_MAJOR\" == \"5.10\" ] || [ \"\$KERNEL_MAJOR\" == \"5.15\" ]; then
                    echo \"ğŸš€ Yeni Nesil (GKI) algÄ±landÄ± -> GKI Yama\"
                    git clone -b gki-android12-5.10 https://gitlab.com/simonpunk/susfs4ksu.git
                    cp -r susfs4ksu/kernel_patches/fs/* fs/
                    cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/
                    for patch in susfs4ksu/kernel_patches/50_gki/*.patch; do
                        patch -p1 < \"\$patch\" || echo \"âš ï¸ GKI Yama UyarÄ±sÄ±\"
                    done
                else
                    echo \"âš ï¸ Bu kernel sÃ¼rÃ¼mÃ¼ (\$KERNEL_MAJOR) iÃ§in otomatik SuSFS yok. Pas geÃ§iliyor.\"
                fi
            fi

            # --- 3. Root Entegrasyonu ---
            echo 'ğŸ› ï¸ Root YÃ¶ntemi: ${{ inputs.ROOT_METHOD }}'
            if [ '${{ inputs.ROOT_METHOD }}' = 'KernelSU' ]; then
                curl -LSs 'https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'KernelSU-Next' ]; then
                curl -LSs 'https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'SukiSU-Ultra' ]; then
                curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'Wild-KSU' ]; then
                curl -LSs 'https://raw.githubusercontent.com/WildKernels/Wild_KSU/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'APatch' ]; then
                git clone https://github.com/bmax121/APatch drivers/apatch
            fi

            # --- 4. Toolchain (Proton Clang) ---
            echo 'ğŸ”§ Toolchain Kuruluyor...'
            git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
            export PATH=/kernel/clang/bin:\$PATH
            export ARCH=arm64
            export SUBARCH=arm64
            export CROSS_COMPILE=aarch64-linux-gnu-
            export CC=clang
            export CLANG_TRIPLE=aarch64-linux-gnu-
            export HOSTCFLAGS='-fcommon'
            export HOSTLDFLAGS='-fcommon'
            export KCFLAGS='-w' 

            # --- 5. Config AyarlarÄ± (Evrensel) ---
            echo 'âš™ï¸ Defconfig YÃ¼kleniyor: ${{ inputs.DEFCONFIG_NAME }}'
            make O=out ${{ inputs.DEFCONFIG_NAME }}

             # 1. ModÃ¼l Ä°mza KontrolÃ¼nÃ¼ Kapat (Eski modÃ¼lleri zorla yÃ¼klesin)
            sed -i 's/CONFIG_MODVERSIONS=y/CONFIG_MODVERSIONS=n/g' out/.config
            sed -i 's/CONFIG_MODULE_SIG=y/CONFIG_MODULE_SIG=n/g' out/.config
            
            # 2. Kernel Versiyonunu Orijinalle EÅŸitlemeye Ã‡alÄ±ÅŸ (Magic Version Hack)
            # Bu satÄ±r Ã§ok kritiktir, cihazÄ±n orijinal kernel sÃ¼rÃ¼m son ekini taklit eder.
            # EÄŸer recovery logundaki "android12-9-..." kÄ±smÄ± sabitse buraya yaz.
            # Ama en garantisi, Localversion'Ä± boÅŸaltÄ±p modÃ¼l korumasÄ±nÄ± kapatmaktÄ±r.
            sed -i 's/CONFIG_LOCALVERSION=.*/CONFIG_LOCALVERSION=""/g' out/.config
            sed -i 's/CONFIG_LOCALVERSION_AUTO=y/CONFIG_LOCALVERSION_AUTO=n/g' out/.config
            
            # 3. GKI ModÃ¼l YÃ¼kleme KorumasÄ±nÄ± KaldÄ±r
            echo 'CONFIG_MODULE_FORCE_LOAD=y' >> out/.config
            echo 'CONFIG_MODULE_ALLOW_MISSING_NAMESPACE_IMPORTS=y' >> out/.config
            echo 'CONFIG_MODULE_SIG_ALL=n' >> out/.config
            echo 'CONFIG_MODULE_SIG_FORCE=n' >> out/.config

            # 4. Samsung GÃ¼venliklerini Tekrar Kontrol Et
            sed -i 's/CONFIG_SEC_SAMSUNG_RKP=y/CONFIG_SEC_SAMSUNG_RKP=n/g' out/.config
            sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' out/.config
            
            # Gereksiz kÄ±sÄ±tlamalarÄ± kaldÄ±r
            sed -i 's/CONFIG_TRIM_UNUSED_KSYMS=y/CONFIG_TRIM_UNUSED_KSYMS=n/g' out/.config
            sed -i 's/CONFIG_UNUSED_KSYMS_WHITELIST=.*/CONFIG_UNUSED_KSYMS_WHITELIST=\"\"/g' out/.config
            
            # Samsung GÃ¼venlik DuvarlarÄ±nÄ± Ä°ndir (Sadece varsa deÄŸiÅŸtirir)
            sed -i 's/CONFIG_SEC_SAMSUNG_RKP=y/CONFIG_SEC_SAMSUNG_RKP=n/g' out/.config
            sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' out/.config
            
            # Root Configleri
            if [ '${{ inputs.ROOT_METHOD }}' = 'APatch' ]; then
                echo 'CONFIG_APATCH=y' >> out/.config
            elif [ '${{ inputs.ROOT_METHOD }}' != 'None' ]; then
                echo 'CONFIG_KSU=y' >> out/.config
            fi
            
            if [ '${{ inputs.USE_SUSFS }}' = 'true' ]; then
                echo 'CONFIG_SUSFS=y' >> out/.config
                echo 'CONFIG_KSU_SUSFS=y' >> out/.config
            fi
            
            make O=out olddefconfig
            
            # --- 6. Derleme ---
            echo 'ğŸ”¥ DERLEME BAÅLIYOR (Ã‡ekirdekler IsÄ±nsÄ±n)...'
            make O=out -j\$(nproc --all) LLVM=1 LLVM_IAS=1

# --- 7. Paketleme (A24 Ä°Ã§in DÃ¼zeltilmiÅŸ) ---
            echo 'ğŸ AkÄ±llÄ± Paketleme BaÅŸlÄ±yor...'
            git clone https://github.com/osm0sis/AnyKernel3
            
            # Kernel DosyasÄ±nÄ± Yakala ve Ä°simlendir
            if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
                echo 'âœ… Image.gz-dtb (MediaTek) Bulundu'
                cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/Image.gz
            elif [ -f out/arch/arm64/boot/Image.gz ]; then
                echo 'âœ… Image.gz (Standart) Bulundu'
                cp out/arch/arm64/boot/Image.gz AnyKernel3/Image.gz
            elif [ -f out/arch/arm64/boot/Image ]; then
                echo 'âœ… Image (Saf) Bulundu'
                cp out/arch/arm64/boot/Image AnyKernel3/Image.gz
            else
                echo 'âŒ HATA: Kernel dosyasÄ± yok! Derleme baÅŸarÄ±sÄ±z olmuÅŸ.'
                exit 1
            fi

            cd AnyKernel3
            
            # --- HAYAT KURTARAN AYARLAR BURADA ---
            
            # 1. Cihaz kontrolÃ¼nÃ¼ kapat (Her modelde Ã§alÄ±ÅŸsÄ±n)
            sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
            
            # 2. Boot Partisyonunu Elle GÃ¶ster (A24/MediaTek Ä°Ã§in Åart)
            sed -i 's|block=auto|block=/dev/block/by-name/boot|g' anykernel.sh
            
            # 3. Samsung AVB Kilidini KÄ±r (Bootloop Ã‡Ã¶zÃ¼mÃ¼)
            # Bu satÄ±r olmadan Samsung cihazlar aÃ§Ä±lmaz!
            sed -i '/boot_attributes() {/a PATCH_VBMETA_FLAG=2;' anykernel.sh
            
            # 4. Magisk ile Ã§akÄ±ÅŸmayÄ± Ã¶nle
            sed -i 's/is_slot_device=0/is_slot_device=auto/g' anykernel.sh

            # Zipleme
            zip -r9 ../Kernel-Installer.zip * -x .git README.md *placeholder
        "

    - name: ğŸ“¤ Sonucu Teslim Et
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Universal-Kernel-Installer
        path: android_kernel/Kernel-Installer.zip
