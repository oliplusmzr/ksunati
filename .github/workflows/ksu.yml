name: Ksunati

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Kaynak Linki'
        required: true
        default: 'https://github.com/oliplusmzr/android_kernel_samsung_a24'
      KERNEL_BRANCH:
        description: 'Branch AdÄ±'
        required: true
        default: 'OSRC'
      DEFCONFIG_NAME:
        description: 'Defconfig Dosya AdÄ±'
        required: true
        default: 'a24_defconfig'
      ROOT_METHOD:
        description: 'Root YÃ¶ntemi'
        required: true
        default: 'KernelSU-Next'
        type: choice
        options:
        - None
        - KernelSU
        - KernelSU-Next
        - APatch

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ðŸ“¥ Kaynak KodlarÄ± Ã‡ek
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.KERNEL_REPO }}
        ref: ${{ inputs.KERNEL_BRANCH }}
        path: android_kernel
        fetch-depth: 1

    - name: ðŸ³ Docker ile Derle (Tam Yetkili)
      run: |
        # KlasÃ¶r izinlerini herkesin eriÅŸebileceÄŸi hale getir
        chmod -R 777 android_kernel
        
        # Docker'Ä± baÅŸlatÄ±yoruz
        docker run --rm -v $PWD/android_kernel:/kernel ubuntu:20.04 bash -c "
            # 1. Paketleri GÃ¼ncelle ve Kur
            echo 'ðŸ“¦ Paketler Kuruluyor...'
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
            git bc bison flex libssl-dev build-essential libncurses5-dev libncurses5 \
            libelf-dev gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi dwarves cpio \
            wget curl kmod ca-certificates python2 python3
            
            # Python ayarÄ± (Eski kerneller python2 isteyebilir)
            ln -sf /usr/bin/python2 /usr/bin/python
            
            # 2. Git GÃ¼venlik AyarÄ± (HAYAT KURTARAN HAMLE)
            git config --global --add safe.directory '*'
            git config --global --add safe.directory /kernel
            
            cd /kernel
            
            # 3. Root YÃ¶ntemini Kur
            echo 'ðŸ› ï¸ Root YÃ¶ntemi: ${{ inputs.ROOT_METHOD }}'
            if [ '${{ inputs.ROOT_METHOD }}' = 'KernelSU' ]; then
                curl -LSs 'https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'KernelSU-Next' ]; then
                curl -LSs 'https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'APatch' ]; then
                git clone https://github.com/bmax121/APatch drivers/apatch
            fi

            # 4. Toolchain Ä°ndir
            echo 'ðŸ”§ Toolchain Ä°ndiriliyor...'
            git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

            # Ortam DeÄŸiÅŸkenleri
            export PATH=/kernel/clang/bin:\$PATH
            export ARCH=arm64
            export SUBARCH=arm64
            export CROSS_COMPILE=aarch64-linux-gnu-
            export CC=clang
            export CLANG_TRIPLE=aarch64-linux-gnu-
            
            # Hata Ã–nleyiciler
            export HOSTCFLAGS='-fcommon'
            export HOSTLDFLAGS='-fcommon'
            # KCFLAGS=-w : UyarÄ±larÄ± hata olarak gÃ¶rme (Werror kapatÄ±r)
            export KCFLAGS='-w' 

            # 5. Config ve Temizlik
            echo 'âš™ï¸ Config: ${{ inputs.DEFCONFIG_NAME }}'
            make O=out ${{ inputs.DEFCONFIG_NAME }}
            
            echo 'ðŸ§¹ Samsung TemizliÄŸi...'
            sed -i 's/CONFIG_TRIM_UNUSED_KSYMS=y/CONFIG_TRIM_UNUSED_KSYMS=n/g' out/.config
            sed -i 's/CONFIG_UNUSED_KSYMS_WHITELIST=.*/CONFIG_UNUSED_KSYMS_WHITELIST=\"\"/g' out/.config
            
            # Root Config Ekleme
            if [ '${{ inputs.ROOT_METHOD }}' = 'APatch' ]; then
                echo 'CONFIG_APATCH=y' >> out/.config
            elif [ '${{ inputs.ROOT_METHOD }}' != 'None' ]; then
                echo 'CONFIG_KSU=y' >> out/.config
            fi
            
            make O=out olddefconfig
            
            # 6. Derleme (AteÅŸle!)
            echo 'ðŸ”¥ DERLEME BAÅžLIYOR...'
            make O=out -j\$(nproc --all) LLVM=1 LLVM_IAS=1
        "

    - name: ðŸ“¤ Sonucu Paketle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.ROOT_METHOD }}
        path: |
          android_kernel/out/arch/arm64/boot/Image*
          android_kernel/out/arch/arm64/boot/*.dtb
          android_kernel/out/arch/arm64/boot/*.gz
