name: ksunati

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Kaynak Linki'
        required: true
        default: 'https://github.com/oliplusmzr/android_kernel_samsung_a24'
      KERNEL_BRANCH:
        description: 'Branch AdÄ±'
        required: true
        default: 'OSRC'
      DEFCONFIG_NAME:
        description: 'Defconfig Dosya AdÄ±'
        required: true
        default: 'a24_defconfig'
      ROOT_METHOD:
        description: 'Root YÃ¶ntemi'
        required: true
        default: 'KernelSU-Next'
        type: choice
        options:
        - None
        - KernelSU
        - KernelSU-Next
        - APatch

jobs:
  build:
    # HÄ±zlÄ± aÃ§Ä±lan makineyi (22.04) kullanÄ±yoruz
    runs-on: ubuntu-22.04
    
    # Ama iÅŸi "Container" iÃ§inde yapÄ±yoruz (Eski ortam - 20.04)
    container:
      image: ubuntu:20.04
    
    steps:
    - name: ðŸ“¦ OrtamÄ± HazÄ±rla (Container Ä°Ã§i)
      run: |
        # Docker iÃ§inde olduÄŸumuz iÃ§in Ã¶nce update
        apt-get update
        # Timezone sorusunu atlamak iÃ§in ayar
        DEBIAN_FRONTEND=noninteractive apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncurses5 libelf-dev gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi dwarves cpio wget curl kmod
        
    - name: ðŸ“¥ Kernel KaynaÄŸÄ±nÄ± Ã‡ek
      run: |
        # GitHub Actions gÃ¼venliÄŸi iÃ§in dizini gÃ¼venli ilan et
        git config --global --add safe.directory $GITHUB_WORKSPACE
        git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} ${{ inputs.KERNEL_REPO }} android_kernel

    - name: ðŸ› ï¸ Root Entegre Et
      working-directory: android_kernel
      run: |
        echo "SeÃ§ilen YÃ¶ntem: ${{ inputs.ROOT_METHOD }}"
        
        if [ "${{ inputs.ROOT_METHOD }}" == "KernelSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
            
        elif [ "${{ inputs.ROOT_METHOD }}" == "KernelSU-Next" ]; then
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -
            
        elif [ "${{ inputs.ROOT_METHOD }}" == "APatch" ]; then
            git clone https://github.com/bmax121/APatch drivers/apatch
        fi

    - name: ðŸ”§ Toolchain (Proton Clang)
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: ðŸ”¥ Derlemeyi BaÅŸlat
      working-directory: android_kernel
      run: |
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        # yylloc Fix
        export HOSTCFLAGS="-fcommon"
        export HOSTLDFLAGS="-fcommon"
        
        # 1. Config OluÅŸtur
        make O=out ${{ inputs.DEFCONFIG_NAME }}
        
        # 2. Samsung TemizliÄŸi
        sed -i 's/CONFIG_TRIM_UNUSED_KSYMS=y/CONFIG_TRIM_UNUSED_KSYMS=n/g' out/.config
        sed -i 's/CONFIG_UNUSED_KSYMS_WHITELIST=.*/CONFIG_UNUSED_KSYMS_WHITELIST=""/g' out/.config
        
        # 3. Root AyarlarÄ±
        if [ "${{ inputs.ROOT_METHOD }}" == "APatch" ]; then
            echo "CONFIG_APATCH=y" >> out/.config
        elif [ "${{ inputs.ROOT_METHOD }}" != "None" ]; then
            echo "CONFIG_KSU=y" >> out/.config
        fi

        # 4. Otomatik Cevaplama
        make O=out olddefconfig

        # 5. Derle
        make O=out -j$(nproc --all) \
            LLVM=1 \
            LLVM_IAS=1

    - name: ðŸ“¤ Sonucu Paketle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.ROOT_METHOD }}
        path: |
          android_kernel/out/arch/arm64/boot/Image*
          android_kernel/out/arch/arm64/boot/*.dtb
          android_kernel/out/arch/arm64/boot/*.gz
