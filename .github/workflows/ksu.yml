name: Ksunati

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Kaynak Linki (Git URL)'
        required: true
        default: 'https://github.com/oliplusmzr/android_kernel_samsung_a24'
      KERNEL_BRANCH:
        description: 'Branch (Dal) AdÄ±'
        required: true
        default: 'OSRC'
      DEFCONFIG_NAME:
        description: 'Defconfig Dosya AdÄ±'
        required: true
        default: 'a24_defconfig'
      ROOT_METHOD:
        description: 'Root YÃ¶ntemi SeÃ§'
        required: true
        default: 'KernelSU-Next'
        type: choice
        options:
        - None
        - KernelSU
        - KernelSU-Next
        - APatch

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ðŸ“¦ OrtamÄ± HazÄ±rla
      run: |
        sudo apt-get update
        sudo apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncurses5 libelf-dev gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi
        
    - name: ðŸ“¥ Kernel KaynaÄŸÄ±nÄ± Ã‡ek
      run: |
        git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} ${{ inputs.KERNEL_REPO }} android_kernel

    - name: ðŸ› ï¸ Root Entegre Et
      working-directory: android_kernel
      run: |
        echo "SeÃ§ilen YÃ¶ntem: ${{ inputs.ROOT_METHOD }}"
        
        if [ "${{ inputs.ROOT_METHOD }}" == "KernelSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
            
        elif [ "${{ inputs.ROOT_METHOD }}" == "KernelSU-Next" ]; then
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -
            
        elif [ "${{ inputs.ROOT_METHOD }}" == "APatch" ]; then
            git clone https://github.com/bmax121/APatch drivers/apatch
        fi

    - name: ðŸ”§ Toolchain (Proton Clang)
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: ðŸ”¥ Derlemeyi BaÅŸlat
      working-directory: android_kernel
      run: |
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        # 1. Config dosyasÄ±nÄ± oluÅŸtur
        make O=out ${{ inputs.DEFCONFIG_NAME }}
        
        # 2. ðŸ”¥ KRÄ°TÄ°K DÃœZELTME: Samsung'un hatalÄ± dosya yollarÄ±nÄ± temizle
        # Whitelist kontrolÃ¼nÃ¼ kapatÄ±yoruz Ã§Ã¼nkÃ¼ dosya yok
        sed -i 's/CONFIG_TRIM_UNUSED_KSYMS=y/CONFIG_TRIM_UNUSED_KSYMS=n/g' out/.config
        # HatalÄ± /home/dpi/... yolunu siliyoruz
        sed -i 's/CONFIG_UNUSED_KSYMS_WHITELIST=.*/CONFIG_UNUSED_KSYMS_WHITELIST=""/g' out/.config
        
        # 3. Root ayarlarÄ±nÄ± config'e iÅŸle
        if [ "${{ inputs.ROOT_METHOD }}" == "APatch" ]; then
            echo "CONFIG_APATCH=y" >> out/.config
        elif [ "${{ inputs.ROOT_METHOD }}" != "None" ]; then
            echo "CONFIG_KSU=y" >> out/.config
        fi

        # 4. Eksik sorularÄ± otomatik cevapla (Error in reading EOF hatasÄ± iÃ§in)
        make O=out olddefconfig

        # 5. Son vuruÅŸu yap (Derle)
        make O=out -j$(nproc --all) \
            LLVM=1 \
            LLVM_IAS=1

    - name: ðŸ“¤ Sonucu Paketle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.ROOT_METHOD }}
        path: |
          android_kernel/out/arch/arm64/boot/Image*
          android_kernel/out/arch/arm64/boot/*.dtb
          android_kernel/out/arch/arm64/boot/*.gz
          
