name: Ksunati

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Kaynak Linki (Git URL)'
        required: true
        default: 'https://github.com/kullanici/cihaz_kernel'
      KERNEL_BRANCH:
        description: 'Branch (Dal) AdÄ±'
        required: true
        default: 'main'
      DEFCONFIG_NAME:
        description: 'Defconfig Dosya AdÄ± (Ã–rn: vendor_cepheus_defconfig)'
        required: true
        default: 'vendor_cepheus_defconfig'
      ROOT_METHOD:
        description: 'Root YÃ¶ntemi SeÃ§'
        required: true
        default: 'KernelSU'
        type: choice
        options:
        - None
        - KernelSU
        - KernelSU-Next
        - APatch

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ðŸ“¦ OrtamÄ± HazÄ±rla
      run: |
        sudo apt-get update
        sudo apt-get install -y git bc bison flex libssl-dev build-essential libncurses5-dev libncurses5 libelf-dev
        
    - name: ðŸ“¥ Kernel KaynaÄŸÄ±nÄ± Ã‡ek
      run: |
        git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} ${{ inputs.KERNEL_REPO }} android_kernel

    - name: ðŸ› ï¸ Root Entegre Et
      working-directory: android_kernel
      run: |
        echo "SeÃ§ilen YÃ¶ntem: ${{ inputs.ROOT_METHOD }}"
        
        if [ "${{ inputs.ROOT_METHOD }}" == "KernelSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
            echo "CONFIG_KSU=y" >> arch/arm64/configs/${{ inputs.DEFCONFIG_NAME }}
            
        elif [ "${{ inputs.ROOT_METHOD }}" == "KernelSU-Next" ]; then
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -
            echo "CONFIG_KSU=y" >> arch/arm64/configs/${{ inputs.DEFCONFIG_NAME }}
            
        elif [ "${{ inputs.ROOT_METHOD }}" == "APatch" ]; then
            git clone https://github.com/bmax121/APatch drivers/apatch
            # APatch manuel ayar gerektirebilir ama basic ekleme yapÄ±yoruz
            echo "CONFIG_APATCH=y" >> arch/arm64/configs/${{ inputs.DEFCONFIG_NAME }}
        fi

    - name: ðŸ”§ Toolchain (Proton Clang)
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: ðŸ”¥ Derlemeyi BaÅŸlat
      working-directory: android_kernel
      run: |
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        # Defconfig dosyasÄ±nÄ± yÃ¼klÃ¼yoruz
        make O=out ${{ inputs.DEFCONFIG_NAME }}
        
        # Derleme komutu
        make O=out -j$(nproc --all) \
            LLVM=1 \
            LLVM_IAS=1

    - name: ðŸ“¤ Sonucu Paketle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.ROOT_METHOD }}
        path: |
          android_kernel/out/arch/arm64/boot/Image*
          android_kernel/out/arch/arm64/boot/*.dtb
          android_kernel/out/arch/arm64/boot/*.gz
          
