name: Ksunati for xiaomi

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: 'Kernel Kaynak Linki'
        required: true
        default: 'https://github.com/AdithyaR-0/Surya_Kernel_4.14' # Ã–rnek Surya linki
      KERNEL_BRANCH:
        description: 'Branch AdÄ±'
        required: true
        default: 'master'
      DEFCONFIG_NAME:
        description: 'Defconfig (Genelde surya_defconfig)'
        required: true
        default: 'surya_defconfig'
      ROOT_METHOD:
        description: 'Root YÃ¶ntemi'
        required: true
        default: 'KernelSU-Next'
        type: choice
        options:
        - None
        - KernelSU
        - KernelSU-Next
        - SukiSU-Ultra
        - Wild-KSU
        - KOWX712-KSU
        - APatch
      USE_SUSFS:
        description: 'ğŸ‘» SuSFS (Hayalet Mod)'
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Kaynak KodlarÄ± Ã‡ek
      run: |
        rm -rf android_kernel
        if [[ "${{ inputs.KERNEL_REPO }}" == http* ]]; then
            git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} ${{ inputs.KERNEL_REPO }} android_kernel
        else
            git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} https://github.com/${{ inputs.KERNEL_REPO }} android_kernel
        fi

    - name: ğŸ³ Docker ile Derle ve Paketle
      run: |
        chmod -R 777 android_kernel
        
        docker run --rm -v $PWD/android_kernel:/kernel ubuntu:20.04 bash -c "
            # 1. AraÃ§larÄ± Kur
            echo 'ğŸ“¦ Paketler Kuruluyor...'
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
            git bc bison flex libssl-dev build-essential libncurses5-dev libncurses5 \
            libelf-dev gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi dwarves cpio \
            wget curl kmod ca-certificates python2 python3 zip unzip
            
            ln -sf /usr/bin/python2 /usr/bin/python
            git config --global --add safe.directory '*'
            git config --global --add safe.directory /kernel
            
            cd /kernel
            
            # 2. SuSFS
            if [ '${{ inputs.USE_SUSFS }}' = 'true' ]; then
                git clone https://gitlab.com/simonpunk/susfs4ksu.git
                cp -r susfs4ksu/kernel_patches/fs/* fs/ || true
                cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/ || true
                for patch in susfs4ksu/kernel_patches/50_gki/*.patch; do
                    patch -p1 < \"\$patch\" || echo \"âš ï¸ Yama uyarÄ±sÄ±\"
                done
            fi

            # 3. Root YÃ¶ntemi
            echo 'ğŸ› ï¸ Root YÃ¶ntemi: ${{ inputs.ROOT_METHOD }}'
            if [ '${{ inputs.ROOT_METHOD }}' = 'KernelSU' ]; then
                curl -LSs 'https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'KernelSU-Next' ]; then
                curl -LSs 'https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'SukiSU-Ultra' ]; then
                curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'Wild-KSU' ]; then
                curl -LSs 'https://raw.githubusercontent.com/WildKernels/Wild_KSU/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'KOWX712-KSU' ]; then
                curl -LSs 'https://raw.githubusercontent.com/KOWX712/KernelSU/main/kernel/setup.sh' | bash -
            elif [ '${{ inputs.ROOT_METHOD }}' = 'APatch' ]; then
                git clone https://github.com/bmax121/APatch drivers/apatch
            fi

            # 4. Toolchain (Proton Clang)
            git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
            export PATH=/kernel/clang/bin:\$PATH
            export ARCH=arm64
            export SUBARCH=arm64
            export CROSS_COMPILE=aarch64-linux-gnu-
            export CC=clang
            export CLANG_TRIPLE=aarch64-linux-gnu-
            export HOSTCFLAGS='-fcommon'
            export HOSTLDFLAGS='-fcommon'
            export KCFLAGS='-w' 

            # 5. Config
            echo 'âš™ï¸ Config: ${{ inputs.DEFCONFIG_NAME }}'
            make O=out ${{ inputs.DEFCONFIG_NAME }}
            
            # --- SAMSUNG KODLARI SÄ°LÄ°NDÄ°, BURASI TEMÄ°Z ---
            
            # Root Configleri
            if [ '${{ inputs.ROOT_METHOD }}' = 'APatch' ]; then
                echo 'CONFIG_APATCH=y' >> out/.config
            elif [ '${{ inputs.ROOT_METHOD }}' != 'None' ]; then
                echo 'CONFIG_KSU=y' >> out/.config
            fi
            
            if [ '${{ inputs.USE_SUSFS }}' = 'true' ]; then
                echo 'CONFIG_SUSFS=y' >> out/.config
                echo 'CONFIG_KSU_SUSFS=y' >> out/.config
            fi
            
            make O=out olddefconfig
            
            echo 'ğŸ”¥ DERLEME BAÅLIYOR...'
            make O=out -j\$(nproc --all) LLVM=1 LLVM_IAS=1

            # 6. AnyKernel3 (Xiaomi/Generic Mod)
            echo 'ğŸ ZIP Paketi HazÄ±rlanÄ±yor...'
            git clone https://github.com/osm0sis/AnyKernel3
            
            # Dosya bulma
            if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
                cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/Image.gz-dtb
            elif [ -f out/arch/arm64/boot/Image.gz ]; then
                cp out/arch/arm64/boot/Image.gz AnyKernel3/Image.gz
            elif [ -f out/arch/arm64/boot/Image ]; then
                cp out/arch/arm64/boot/Image AnyKernel3/Image
            else
                echo 'âŒ Image dosyasÄ± bulunamadÄ±!'
                exit 1
            fi

            cd AnyKernel3
            # Cihaz kontrolÃ¼nÃ¼ kapatÄ±yoruz, her cihaza uysun
            sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
            
            # Samsung iÃ§in yaptÄ±ÄŸÄ±mÄ±z Ã¶zel path ayarÄ±nÄ± kaldÄ±rdÄ±k.
            # AnyKernel3 otomatik olarak Snapdragon'u tanÄ±r.
            
            zip -r9 ../Kernel-Installer-Surya.zip * -x .git README.md *placeholder
        "

    - name: ğŸ“¤ ZIP DosyasÄ±nÄ± YÃ¼kle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Surya-Kernel-ZIP
        path: android_kernel/Kernel-Installer-Surya.zip
        
